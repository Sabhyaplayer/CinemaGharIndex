<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CinemaGhar Index</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style type="text/css">
/* <![CDATA[ */
:root {
    --primary-color: #007bff;
    --primary-hover: #0056b3;
    --light-bg: #f8f9fa;
    --container-bg: #ffffff;
    --text-color: #343a40;
    --text-muted: #6c757d;
    --border-color: #dee2e6;
    --header-bg: #ffffff;
    --table-header-bg: #e9ecef;
    --table-row-hover: #f1f3f5;
    --error-color: #dc3545;
    --success-color: #28a745;
    --warning-bg: #fff3cd;
    --warning-text: #856404;
    --warning-border: #ffeeba;
    --pagination-active-bg: #007bff;
    --pagination-active-border: #007bff;
    --pagination-hover-bg: #e9ecef;
    --pagination-disabled-color: #adb5bd;
    --pagination-disabled-bg: #ffffff;
    --pagination-disabled-border: #dee2e6;
    --filter-active-border: #adb5bd;

    --border-radius-sm: 0.25rem;
    --border-radius-md: 0.5rem;
    --border-radius-lg: 0.8rem;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 10px rgba(0,0,0,0.08);
}

*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

html, body {
    width: 100%;
    height: 100%;
}

body {
     font-family: 'Poppins', Arial, sans-serif;
     background-color: var(--light-bg);
     color: var(--text-color);
     line-height: 1.6;
}
#cinemaghar-container {
    font-family: 'Poppins', Arial, sans-serif;
    padding: 15px;
    background-color: var(--container-bg);
    border-radius: var(--border-radius-lg);
    margin: 20px auto;
    max-width: 1200px;
    box-shadow: var(--shadow-md);
    position: relative;
    color: var(--text-color);
    overflow: hidden;
}

#cinemaghar-container header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
    flex-wrap: wrap;
    background-color: var(--header-bg);
    padding: 15px;
    border-radius: var(--border-radius-md) var(--border-radius-md) 0 0;
    margin: -15px -15px 25px -15px;
}
#cinemaghar-container header img {
    height: 60px;
    border-radius: var(--border-radius-md);
    flex-shrink: 0;
    box-shadow: var(--shadow-sm);
}
#cinemaghar-container .header-title-signature {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    min-width: 0;
}
#cinemaghar-container .header-title-signature h1 {
    font-size: 26px;
    font-weight: 600;
    margin: 0;
    color: var(--text-color);
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
#cinemaghar-container .header-title-signature .signature {
    font-size: 13px;
    color: var(--text-muted);
    margin: 4px 0 0 0;
    font-style: italic;
    font-weight: 300;
    padding-left: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
#cinemaghar-container .header-buttons {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-shrink: 0;
}
#cinemaghar-container .header-buttons .button svg {
    height: 1.1em;
    width: 1.1em;
    margin-right: 6px;
    vertical-align: text-bottom;
    fill: currentColor;
}

#cinemaghar-container h2 {
    font-size: 22px;
    color: var(--primary-color);
    font-weight: 600;
    margin-top: 35px;
    margin-bottom: 18px;
    padding-bottom: 8px;
    border-bottom: 2px solid var(--primary-color);
}

.filter-search-area {
    display: flex;
    gap: 15px;
    margin: 10px 0 25px 0;
    align-items: center;
    flex-wrap: wrap;
}

.search-group {
    display: flex;
    flex-grow: 1;
    min-width: 250px;
}

#cinemaghar-container #searchInput {
    flex-grow: 1;
    padding: 12px 15px;
    border-radius: var(--border-radius-md);
    border: 1px solid var(--border-color);
    font-size: 16px;
    box-sizing: border-box;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
    height: 44px;
    outline: none;
}
#cinemaghar-container #searchInput:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
    z-index: 1;
    position: relative;
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
}

.filter-group label {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-muted);
    white-space: nowrap;
}

#cinemaghar-container #qualityFilterSelect {
    padding: 10px 12px;
    border-radius: var(--border-radius-md);
    border: 1px solid var(--border-color);
    font-size: 14px;
    background-color: white;
    cursor: pointer;
    transition: border-color 0.2s ease, background-color 0.2s ease;
    min-width: 150px;
    height: 44px;
    line-height: 1.5;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%236c757d" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>');
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 16px 12px;
    padding-right: 35px;
}
#cinemaghar-container #qualityFilterSelect:focus {
    border-color: var(--primary-color);
    outline: none;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
}
#cinemaghar-container #qualityFilterSelect.filter-active {
    border-color: var(--filter-active-border);
    background-color: #eef;
    font-weight: 500;
}

#cinemaghar-container .table-container {
    overflow-x: auto;
    background: var(--container-bg);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-md);
    margin-bottom: 10px;
    border: 1px solid var(--border-color);
}
#cinemaghar-container table {
    width: 100%;
    border-collapse: collapse;
    min-width: 700px;
}
#cinemaghar-container th, #cinemaghar-container td {
    padding: 13px 12px;
    border: none;
    border-bottom: 1px solid var(--border-color);
    text-align: left;
    font-size: 14px;
    vertical-align: middle;
    font-weight: 400;
}
#cinemaghar-container th.col-id, #cinemaghar-container td.col-id,
#cinemaghar-container th.col-size, #cinemaghar-container td.col-size,
#cinemaghar-container th.col-quality, #cinemaghar-container td.col-quality,
#cinemaghar-container th.col-updated, #cinemaghar-container td.col-updated,
#cinemaghar-container th.col-view, #cinemaghar-container td.col-view {
    text-align: center;
    white-space: nowrap;
}

#cinemaghar-container th {
    background-color: var(--table-header-bg);
    font-weight: 600;
    color: var(--text-color);
    white-space: nowrap;
    position: sticky;
    top: 0;
    z-index: 2;
    cursor: pointer;
    user-select: none;
}
#cinemaghar-container th.sortable:hover {
    background-color: #dde2e6;
}
#cinemaghar-container th .sort-indicator {
    display: inline-block;
    width: 0;
    height: 0;
    border-left: 5px solid transparent;
    border-right: 5px solid transparent;
    margin-left: 6px;
    vertical-align: middle;
    opacity: 0.5;
    transition: opacity 0.2s ease, border-color 0.2s;
}
#cinemaghar-container th.sort-asc .sort-indicator {
    border-bottom: 5px solid var(--primary-color);
    opacity: 1;
}
#cinemaghar-container th.sort-desc .sort-indicator {
    border-top: 5px solid var(--primary-color);
    opacity: 1;
}
#cinemaghar-container th:not(.sortable) .sort-indicator { display: none; }
#cinemaghar-container th:not(.sortable) { cursor: default; }
/* Column widths */
#cinemaghar-container th.col-id, #cinemaghar-container td.col-id { width: 6%; }
#cinemaghar-container th.col-filename, #cinemaghar-container td.col-filename { width: 45%; }
#cinemaghar-container th.col-size, #cinemaghar-container td.col-size { width: 12%; }
#cinemaghar-container th.col-quality, #cinemaghar-container td.col-quality { width: 12%; }
#cinemaghar-container th.col-updated, #cinemaghar-container td.col-updated { width: 15%; }
#cinemaghar-container th.col-view, #cinemaghar-container td.col-view { width: 10%; }

#cinemaghar-container tr:last-child td {
    border-bottom: none;
}
#cinemaghar-container tbody tr:not(.action-row):hover {
    background-color: var(--table-row-hover);
    cursor: default;
}

#cinemaghar-container td.col-filename {
    word-break: break-all;
    text-align: left;
    min-width: 150px;
    cursor: pointer;
    color: var(--primary-color);
    font-weight: 500;
    transition: color 0.2s ease;
    white-space: normal;
    position: relative;
}
#cinemaghar-container td.col-filename:hover {
    color: var(--primary-hover);
    text-decoration: underline;
}

#cinemaghar-container td.col-filename .quality-logo {
    height: 1.1em;
    width: auto;
    vertical-align: text-bottom;
    margin-left: 5px;
    display: inline-block;
    line-height: 1;
    filter: grayscale(30%);
    opacity: 0.8;
    transition: filter 0.2s ease, opacity 0.2s ease;
}
#cinemaghar-container td.col-filename:hover .quality-logo {
    filter: grayscale(0%);
    opacity: 1;
}

#cinemaghar-container td.col-quality {
    text-align: center;
    min-width: 80px;
    white-space: nowrap;
    font-weight: 500;
}
#cinemaghar-container td.col-updated {
    white-space: nowrap;
    min-width: 130px;
    color: var(--text-muted);
    font-size: 13px;
}
#cinemaghar-container td.status-message,
#cinemaghar-container td.error-message {
    color: var(--text-muted);
    font-style: italic;
    text-align: center;
    padding: 20px;
    font-size: 15px;
}
#cinemaghar-container td.error-message {
    color: var(--error-color);
    font-weight: 500;
}

/* Action Row */
#cinemaghar-container tr.action-row {
    display: none;
    background-color: #f0f2f5;
}
#cinemaghar-container .action-row td {
    padding: 20px 15px;
    text-align: left;
    border-bottom: none;
    box-shadow: inset 0 3px 5px rgba(0,0,0,0.04);
}
#cinemaghar-container .action-info {
    margin-bottom: 20px;
    font-size: 14px;
    color: var(--text-muted);
    text-align: left;
    line-height: 1.7;
}
#cinemaghar-container .action-info .info-item {
    display: block;
    margin-bottom: 8px;
}
#cinemaghar-container .action-info strong {
    color: var(--text-color);
    font-weight: 600;
    margin-right: 8px;
    display: inline-block;
    min-width: 80px;
}
#cinemaghar-container .action-info .quality-logo {
    height: 1.1em;
    width: auto;
    vertical-align: text-bottom;
    margin-left: 4px;
    display: inline-block;
}

#cinemaghar-container .action-buttons-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: flex-start;
    gap: 10px;
    margin-bottom: 15px;
    border-top: 1px solid var(--border-color);
    padding-top: 20px;
}

/* Buttons */
#cinemaghar-container .button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 9px 16px;
    margin: 2px 0;
    background-color: var(--success-color); /* Default */
    color: white !important;
    border: none;
    border-radius: var(--border-radius-md);
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    text-align: center;
    white-space: nowrap;
    line-height: 1.4;
    transition: all 0.2s ease-in-out;
    box-shadow: var(--shadow-sm);
}
#cinemaghar-container .button:hover {
    opacity: 1;
    filter: brightness(1.1);
    box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    transform: translateY(-1px);
}
#cinemaghar-container .button:active {
    filter: brightness(0.95);
    transform: translateY(0);
    box-shadow: var(--shadow-sm);
}

/* Specific Button Colors */
#cinemaghar-container .view-button { background-color: #6c757d; }
#cinemaghar-container .view-button:hover { background-color: #5a6268; }
#cinemaghar-container .play-button { background-color: var(--success-color); }
#cinemaghar-container .intent-button { background-color: #17a2b8; }
#cinemaghar-container .vlc-button { background-color: #fd7e14; }
#cinemaghar-container .download-button { background-color: var(--primary-color); }
#cinemaghar-container .telegram-button { background-color: #0088cc; }
#cinemaghar-container .gdflix-button { background-color: #E50914; }
#cinemaghar-container .hubcloud-button { background-color: #1E90FF; } /* Added */
#cinemaghar-container .filepress-button { background-color: #6c757d; } /* Added */
#cinemaghar-container .gdtot-button { background-color: #ffc107; color: #333 !important; } /* Added */


/* Copy Feedback */
#cinemaghar-container .copy-feedback {
    display: inline-block;
    margin-left: 10px;
    font-size: 13px;
    color: var(--success-color);
    font-weight: 600;
    opacity: 0;
    transition: opacity 0.3s ease;
    vertical-align: middle;
}
#cinemaghar-container .copy-feedback.show {
    opacity: 1;
}

/* Video Player Container */
#cinemaghar-container .video-container {
    display: none;
    margin: 20px auto 0 auto;
    background: #f1f3f5;
    padding: 50px 20px 20px 20px;
    border-radius: var(--border-radius-lg);
    box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    position: relative;
    box-sizing: border-box;
    width: 100%;
    max-width: 850px;
    text-align: center;
    display: flex;
    flex-direction: column;
}
#cinemaghar-container .close-btn {
    position: absolute;
    top: 15px;
    right: 18px;
    background: var(--error-color);
    color: white !important;
    border: none;
    padding: 6px 12px;
    border-radius: var(--border-radius-md);
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    z-index: 10;
    transition: background-color 0.2s ease;
}
#cinemaghar-container .close-btn:hover {
    background-color: #c82333;
}
#cinemaghar-container #audioWarning {
    display: none;
    background-color: var(--warning-bg);
    color: var(--warning-text);
    border: 1px solid var(--warning-border);
    padding: 12px;
    margin-bottom: 15px;
    border-radius: var(--border-radius-md);
    font-size: 14px;
    text-align: center;
    position: relative;
    z-index: 1;
    line-height: 1.5;
    flex-shrink: 0;
}
#cinemaghar-container #audioWarning strong { font-weight: 600; }
#cinemaghar-container #html5VideoPlayer {
    width: 100%;
    max-height: 480px;
    display: block;
    margin: 10px auto 15px auto;
    background: black;
    border-radius: var(--border-radius-md);
    outline: none;
    box-shadow: var(--shadow-md);
    flex-shrink: 1;
    flex-grow: 1;
    object-fit: contain;
    cursor: default;
}
#cinemaghar-container .custom-controls {
    margin-top: 10px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    flex-shrink: 0;
    position: relative;
}
/* Style custom control buttons */
#cinemaghar-container .custom-controls .button {
    background-color: #5a6268;
    min-width: 60px;
    font-size: 12px;
    padding: 6px 10px;
    color: white !important;
}
#cinemaghar-container .custom-controls .button:hover {
    background-color: #495057;
}
#cinemaghar-container #audioTrackSelect {
    padding: 6px 10px;
    border-radius: var(--border-radius-md);
    background-color: #e9ecef;
    border: 1px solid var(--border-color);
    font-size: 13px;
    font-family: inherit;
    cursor: pointer;
    max-width: 150px;
    display: none;
    transition: border-color 0.2s ease;
    height: 30px;
    line-height: 1;
    vertical-align: middle;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%236c757d" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>');
    background-repeat: no-repeat;
    background-position: right 5px center;
    background-size: 12px 10px;
    padding-right: 25px;
}
#cinemaghar-container #audioTrackSelect:focus {
    border-color: var(--primary-color);
    outline: none;
}
#cinemaghar-container #videoTitle {
    font-weight: 600;
    margin-bottom: 15px;
    font-size: 18px;
    color: var(--text-color);
    position: relative;
    z-index: 1;
    padding-top: 0;
    text-align: left;
    word-break: break-word;
    flex-shrink: 0;
}
#cinemaghar-container .vlc-copy-box {
    margin-top: 20px;
    background: #e9ecef;
    padding: 12px 15px;
    border-radius: var(--border-radius-md);
    font-size: 14px;
    word-wrap: break-word;
    line-height: 1.6;
    color: var(--text-muted);
    text-align: left;
    border: 1px solid var(--border-color);
    flex-shrink: 0;
}
#cinemaghar-container .vlc-copy-box strong {
    color: var(--text-color);
    font-weight: 600;
    display: block;
    margin-bottom: 5px;
}
#cinemaghar-container .vlc-copy-box code {
    background: #dcdcdc;
    padding: 3px 6px;
    border-radius: var(--border-radius-sm);
    font-family: 'Courier New', Courier, monospace;
    word-break: break-all;
    color: #333;
    font-size: 13px;
    display: block;
    margin-top: 3px;
    user-select: all;
}

/* Player Controls Grouping */
.player-control-group {
    display: flex;
    align-items: center;
    gap: 6px;
}
.player-control-group label {
    font-size: 12px;
    color: var(--text-muted);
    white-space: nowrap;
}
#volumeSlider {
    width: 80px;
    cursor: pointer;
    height: 5px;
    transition: opacity 0.2s ease;
    vertical-align: middle;
    accent-color: var(--primary-color);
}
#playbackSpeedSelect {
    padding: 4px 8px;
    font-size: 12px;
    border-radius: var(--border-radius-sm);
    border: 1px solid var(--border-color);
    background-color: #fff;
    height: 30px;
    line-height: 1;
    vertical-align: middle;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%236c757d" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>');
    background-repeat: no-repeat;
    background-position: right 5px center;
    background-size: 12px 10px;
    padding-right: 25px;
}

/* --- Fullscreen Specific Styles --- */
#cinemaghar-container .video-container.is-fullscreen {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    max-width: none;
    padding: 0;
    margin: 0;
    border-radius: 0;
    background-color: black;
    z-index: 2147483647;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

#cinemaghar-container .video-container.is-fullscreen #html5VideoPlayer {
    width: 100%;
    height: 100%;
    max-height: none;
    flex-grow: 1;
    flex-shrink: 1;
    border-radius: 0;
    box-shadow: none;
    margin: 0;
    object-fit: contain;
    cursor: default;
}

/* --- HIDE CONTROLS IN FULLSCREEN --- */
#cinemaghar-container .video-container.is-fullscreen .custom-controls {
    display: none !important;
}
#cinemaghar-container .video-container.is-fullscreen .close-btn {
    display: none !important;
}

#cinemaghar-container .video-container.is-fullscreen #videoTitle,
#cinemaghar-container .video-container.is-fullscreen #audioWarning,
#cinemaghar-container .video-container.is-fullscreen .vlc-copy-box {
    display: none !important;
}
/* --- End Fullscreen Specific Styles --- */

/* Pagination */
.pagination-container {
    text-align: center;
    margin: 25px 0 10px 0;
    user-select: none;
}
.pagination-container button,
.pagination-container span {
    display: inline-block;
    padding: 8px 14px;
    margin: 0 3px;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-md);
    background-color: white;
    color: var(--primary-color);
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
    vertical-align: middle;
}
.pagination-container button:hover:not(:disabled) {
    background-color: var(--pagination-hover-bg);
    border-color: #adb5bd;
}
.pagination-container span.current-page {
    background-color: var(--pagination-active-bg);
    border-color: var(--pagination-active-border);
    color: white;
    font-weight: 600;
    cursor: default;
}
.pagination-container button:disabled {
    color: var(--pagination-disabled-color);
    background-color: var(--pagination-disabled-bg);
    border-color: var(--pagination-disabled-border);
    cursor: not-allowed;
    opacity: 0.7;
}
.pagination-container .page-info {
    font-size: 13px;
    color: var(--text-muted);
    margin: 0 5px;
    padding: 8px 0;
    border: none;
    background: none;
    cursor: default;
    display: inline-block;
    vertical-align: middle;
}

/* Spinner */
.spinner {
    border: 4px solid rgba(0, 0, 0, 0.1);
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border-left-color: var(--primary-color);
    margin: 30px auto;
    animation: spin 1s ease infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Responsive Styles */
@media screen and (max-width: 768px) {
  body { font-size: 14px; }
  #cinemaghar-container { padding: 10px; margin: 10px; }

  #cinemaghar-container header {
      padding: 12px 10px;
      margin: -10px -10px 20px -10px;
      gap: 10px;
      flex-direction: column;
      align-items: flex-start;
  }
  #cinemaghar-container header img { height: 45px; }
  #cinemaghar-container .header-title-signature h1 { font-size: 20px; }
  #cinemaghar-container .header-title-signature .signature { font-size: 12px; }
  #cinemaghar-container .header-buttons {
      gap: 8px;
      width: 100%;
      justify-content: flex-start;
      flex-wrap: wrap;
  }
  #cinemaghar-container .header-buttons .button {
      font-size: 12px;
      padding: 8px 12px;
   }
  #cinemaghar-container .header-buttons .button svg { height: 1em; width: 1em; margin-right: 5px;}

  .filter-search-area {
      flex-direction: column;
      align-items: stretch;
      gap: 12px;
  }
  .search-group {
      min-width: unset;
  }
  #cinemaghar-container #searchInput {
      min-width: unset;
      width: 100%;
      font-size: 15px;
      padding: 11px 13px;
      height: 40px;
      border-radius: var(--border-radius-md);
  }

  .filter-group {
      justify-content: space-between;
      gap: 10px;
  }
  .filter-group label { font-size: 13px; margin-right: 5px;}
  #cinemaghar-container #qualityFilterSelect {
      font-size: 14px;
      padding: 9px 10px;
      min-width: unset;
      flex-grow: 1;
      width: auto;
      height: 40px;
      padding-right: 30px;
      background-position: right 8px center;
  }

  #cinemaghar-container .table-container {
      border: none;
      box-shadow: none;
      border-radius: 0;
      margin-left: -10px;
      margin-right: -10px;
      overflow-x: visible;
   }
   #cinemaghar-container table {
        min-width: unset;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-md);
        box-shadow: var(--shadow-sm);
        display: block;
        overflow-x: auto;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
   }
   #cinemaghar-container thead, #cinemaghar-container tbody, #cinemaghar-container tr {
        display: table;
        width: 100%;
        table-layout: fixed;
   }
   #cinemaghar-container thead {
        position: sticky;
        top: 0;
        z-index: 3;
   }

  #cinemaghar-container th, #cinemaghar-container td {
      padding: 10px 8px;
      font-size: 13px;
      border-bottom: 1px solid var(--border-color);
      display: table-cell;
      white-space: normal;
      vertical-align: middle;
  }

  /* Hide columns on mobile */
  #cinemaghar-container thead tr th.col-size,
  #cinemaghar-container thead tr th.col-updated,
  #cinemaghar-container tbody tr:not(.action-row) td.col-size,
  #cinemaghar-container tbody tr:not(.action-row) td.col-updated {
       display: none;
  }

   /* Adjust visible column widths */
   #cinemaghar-container th.col-id, #cinemaghar-container td.col-id { width: 12%; text-align: center; }
   #cinemaghar-container th.col-filename, #cinemaghar-container td.col-filename { width: 48%; font-weight: 500; }
   #cinemaghar-container th.col-quality, #cinemaghar-container td.col-quality { width: 20%; text-align: center; font-weight: 500;}
   #cinemaghar-container th.col-view, #cinemaghar-container td.col-view { width: 20%; text-align: center; }

  #cinemaghar-container th .sort-indicator { margin-left: 4px; border-width: 4px; }
  #cinemaghar-container th.sort-asc .sort-indicator { border-bottom-width: 4px; }
  #cinemaghar-container th.sort-desc .sort-indicator { border-top-width: 4px; }

  #cinemaghar-container td.col-filename {
      word-break: break-word;
      white-space: normal;
      cursor: pointer;
  }
  #cinemaghar-container td.col-filename .quality-logo {
       height: 0.9em;
       margin-left: 3px;
       vertical-align: baseline;
  }
  #cinemaghar-container td.col-quality { min-width: unset; }

   #cinemaghar-container td.col-view .button.view-button {
      font-size: 12px;
      padding: 6px 8px;
      width: 100%;
      min-width: 45px;
      box-sizing: border-box;
   }

   #cinemaghar-container .action-row td {
        padding: 15px 10px;
        display: block;
        width: auto;
        white-space: normal;
   }

  #cinemaghar-container .action-info {
      font-size: 13px;
      margin-bottom: 15px;
  }
   #cinemaghar-container .action-info .info-item {
        display: block;
        margin-bottom: 6px;
        line-height: 1.5;
   }
   #cinemaghar-container .action-info strong {
        display: inline-block;
        min-width: 65px;
        font-weight: 600;
        margin-right: 5px;
   }
   #cinemaghar-container .action-info .quality-logo {
        height: 0.9em;
        vertical-align: baseline;
   }

  #cinemaghar-container .action-buttons-container {
      flex-direction: column;
      align-items: stretch;
      gap: 8px;
      padding-top: 15px;
  }
  #cinemaghar-container .action-buttons-container .button {
      font-size: 13px;
      padding: 10px 15px;
      width: 100%;
      max-width: none;
      margin: 0;
      box-sizing: border-box;
  }

  #cinemaghar-container #html5VideoPlayer { max-height: 280px; }
  #cinemaghar-container .video-container {
      padding: 45px 10px 15px 10px;
      max-width: 100%;
      margin-left: 0;
      margin-right: 0;
      border-radius: var(--border-radius-md);
  }
  #cinemaghar-container .video-container.is-fullscreen #html5VideoPlayer {
      max-height: none;
  }
  #cinemaghar-container .close-btn { top: 12px; right: 12px; padding: 5px 9px; font-size: 12px; }
  #cinemaghar-container #videoTitle { font-size: 16px; }
  #cinemaghar-container #audioWarning { font-size: 12px; padding: 10px; line-height: 1.4; }
  #cinemaghar-container .custom-controls { gap: 8px; }
  #cinemaghar-container .custom-controls .button { padding: 7px 10px; font-size: 11px; min-width: 55px;}
  #cinemaghar-container #audioTrackSelect { font-size: 12px; padding: 5px 8px; max-width: 120px; height: 34px; }
  #cinemaghar-container .vlc-copy-box { font-size: 12px; padding: 10px; }
  #cinemaghar-container .vlc-copy-box code { font-size: 11px; }
  .player-control-group label { font-size: 11px;}
  #volumeSlider { width: 60px;}
  #playbackSpeedSelect { font-size: 12px; padding: 3px 6px; height: 34px; }

    .pagination-container { margin: 20px 0 5px 0; }
    .pagination-container button,
    .pagination-container span { padding: 7px 11px; font-size: 13px; margin: 0 2px;}
    .pagination-container .page-info { font-size: 12px; margin: 0 5px; padding: 7px 0;}
}
/* ]]> */
</style>
</head>
<body>

<div id="cinemaghar-container">

  <header>
    <img src="https://i.ibb.co/s1Kn4MT/c68903b0d838.jpg" alt="CinemaGhar Logo" />
    <div class="header-title-signature">
        <h1>CinemaGhar Index</h1>
        <p class="signature">Curated with ❣️ by The_SabhyaPlayer</p>
    </div>
    <div class="header-buttons">
        <a href="https://t.me/The_Sabhyaplayer_bot" target="_blank" rel="noopener noreferrer" class="button telegram-button">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240" aria-hidden="true" focusable="false" style="width:1.1em; height:1.1em; fill:currentColor; margin-right:6px; vertical-align:text-bottom;">
                <path d="M97.9,161.4l-2.8,29.9c3.4,0,4.9-1.7,6.8-3.6l14.1-13.6l29.4,21.7c5.4,3.1,9.3,1.5,10.8-4.9l19.9-93.5c1.8-7.8-2.4-11.5-7.5-9.3L36.4,127.1c-7.6,3-7.6,7.5-1.3,9.6l30.2,9.4l70.4-44.3c3.3-2,6.1-0.9,3.6,1.4L97.9,161.4z"/>
            </svg>
            <span>Contact The_SabhyaPlayer</span>
        </a>
        <a href="https://t.me/Cinemaghar_Lobby" target="_blank" rel="noopener noreferrer" class="button telegram-button">
             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240" aria-hidden="true" focusable="false" style="width:1.1em; height:1.1em; fill:currentColor; margin-right:6px; vertical-align:text-bottom;">
                 <path d="M97.9,161.4l-2.8,29.9c3.4,0,4.9-1.7,6.8-3.6l14.1-13.6l29.4,21.7c5.4,3.1,9.3,1.5,10.8-4.9l19.9-93.5c1.8-7.8-2.4-11.5-7.5-9.3L36.4,127.1c-7.6,3-7.6,7.5-1.3,9.6l30.2,9.4l70.4-44.3c3.3-2,6.1-0.9,3.6,1.4L97.9,161.4z"/>
             </svg>
            <span>Join Channel</span>
        </a>
    </div>
  </header>

  <div class="filter-search-area">
      <div class="search-group">
          <input type="search" id="searchInput" placeholder="Search movies by name or ID..." />
          <!-- Search Button Removed -->
      </div>
      <div class="filter-group">
          <label for="qualityFilterSelect">Quality:</label>
          <select id="qualityFilterSelect">
              <option value="">All Qualities</option>
              <!-- Options populated by JS -->
          </select>
      </div>
  </div>

  <div id="updatesSection">
    <h2>Updates (Last 24 Hours)</h2>
    <div class="table-container">
      <table id="updatesTable">
        <thead>
            <tr>
                <th class="col-id">#</th>
                <th class="col-filename">Filename</th>
                <th class="col-size">Size</th>
                <th class="col-quality">Quality</th>
                <th class="col-updated">Updated</th>
                <th class="col-view">View</th>
             </tr>
         </thead>
        <tbody id="updatesTableBody">
            <!-- Content generated by JS -->
        </tbody>
      </table>
    </div>
  </div>

  <h2>Recently Listed</h2>
  <div class="table-container">
    <table id="movieTable">
      <thead>
          <tr>
              <th class="sortable col-id" data-sort-key="id">#<span class="sort-indicator"></span></th>
              <th class="sortable col-filename" data-sort-key="filename">Filename<span class="sort-indicator"></span></th>
              <th class="sortable col-size" data-sort-key="size">Size<span class="sort-indicator"></span></th>
              <th class="sortable col-quality" data-sort-key="quality">Quality<span class="sort-indicator"></span></th>
              <th class="sortable col-updated" data-sort-key="lastUpdated">Updated<span class="sort-indicator"></span></th>
              <th class="col-view">View</th>
          </tr>
      </thead>
      <tbody id="movieTableBody">
         <!-- Content generated by JS -->
      </tbody>
    </table>
  </div>

  <div class="pagination-container" id="paginationControls" style="display: none;">
      <!-- Content generated by JS -->
  </div>

  <!-- Video Player Container - Moved here from within action row for structural sanity -->
  <!-- It will be appended to the correct action row cell dynamically -->
  <div class="video-container" id="videoContainer">
      <button class="close-btn" onclick="closePlayer()">✖ Close</button>
      <div id="audioWarning" style="display: none;"></div>
      <div id="videoTitle"></div>
      <video id="html5VideoPlayer" controls autoplay controlsList="nodownload noremoteplayback">
          Your browser does not support the video tag.
      </video>
      <div class="custom-controls" id="customControlsContainer">
          <button class="button" onclick="seekVideo(-10)">« 10s</button>
          <button class="button" onclick="seekVideo(10)">10s »</button>
          <button class="button" id="muteButton" onclick="toggleMute()">Mute</button>

          <div class="player-control-group">
            <label for="volumeSlider">Vol:</label>
            <input type="range" id="volumeSlider" min="0" max="1" step="0.05" value="1" oninput="setVolume(this.value)" onchange="setVolume(this.value)">
          </div>

          <select id="audioTrackSelect" onchange="changeAudioTrack(this)" title="Select Audio Track"></select>

          <div class="player-control-group">
             <label for="playbackSpeedSelect">Speed:</label>
             <select id="playbackSpeedSelect" onchange="setPlaybackSpeed(this.value)">
                <option value="0.5">0.5x</option>
                <option value="0.75">0.75x</option>
                <option value="1" selected>1x</option>
                <option value="1.25">1.25x</option>
                <option value="1.5">1.5x</option>
                <option value="2">2x</option>
             </select>
          </div>

          <button class="button" onclick="toggleFullscreen()">Fullscreen</button>
      </div>
      <div class="vlc-copy-box" id="vlcBox" style="display:none;">
          <strong>External Player URL:</strong>
          <code id="vlcText"></code>
          <span class="copy-feedback" id="copyFeedback">Copied!</span>
      </div>
  </div>

</div> <!-- End #cinemaghar-container -->

<script type="text/javascript">
// <![CDATA[

const config = {
    // !!! IMPORTANT: Paste your **NEW** Google Apps Script Web App URL here !!!
    GSheetWebAppURL: "https://script.google.com/macros/s/AKfycbzcV_vEcrlZYVYnw-RFQOsHtzfdIIEwh4Vfp2tPp2wR1I8by2TDTGyQZH9i2Gy-0WMoAw/exec",
    // ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

    HDR_LOGO_URL: "https://as1.ftcdn.net/v2/jpg/05/32/83/72/1000_F_532837228_v8CGZRU0jy39uCtqFRnJz6xDntrGuLLx.webp",
    FOURK_LOGO_URL: "https://i.pinimg.com/736x/85/c4/b0/85c4b0a2fb8612825d0cd2f53460925f.jpg",
    ITEMS_PER_PAGE: 50,
    LOCAL_STORAGE_KEY: 'cinemaGharState_v2',
    PLAYER_VOLUME_KEY: 'cinemaGharPlayerVolume',
    PLAYER_SPEED_KEY: 'cinemaGharPlayerSpeed',
    SEARCH_DEBOUNCE_DELAY: 350 // Delay in ms for real-time search
};

let allMovieData = [];
let filteredAndSortedData = [];
let uniqueQualities = new Set();
let activeActionRow = null;
let copyTimeout;
let searchDebounceTimeout;

// --- State Management ---
let currentState = {
    searchTerm: '',
    qualityFilter: '',
    sortColumn: 'lastUpdated',
    sortDirection: 'desc',
    currentPage: 1
};

// --- DOM Element References ---
const container = document.getElementById('cinemaghar-container');
const videoContainer = document.getElementById('videoContainer');
const videoElement = document.getElementById('html5VideoPlayer');
const videoTitle = document.getElementById('videoTitle');
const vlcBox = document.getElementById('vlcBox');
const vlcText = document.getElementById('vlcText');
const searchInput = document.getElementById('searchInput');
const qualityFilterSelect = document.getElementById('qualityFilterSelect');
const audioWarningDiv = document.getElementById('audioWarning');
const updatesSection = document.getElementById('updatesSection');
const updatesTableBody = document.getElementById('updatesTableBody');
const movieTableBody = document.getElementById('movieTableBody');
const movieTableHead = document.querySelector('#movieTable thead');
const muteButton = document.getElementById('muteButton');
const volumeSlider = document.getElementById('volumeSlider');
const playbackSpeedSelect = document.getElementById('playbackSpeedSelect');
const customControlsContainer = document.getElementById('customControlsContainer');
const audioTrackSelect = document.getElementById('audioTrackSelect');
const copyFeedbackSpan = document.getElementById('copyFeedback');
const paginationControlsContainer = document.getElementById('paginationControls');
const playerCloseButton = document.querySelector('.video-container .close-btn');


// --- Utility Functions ---

/**
 * Sanitizes a string to prevent XSS by converting it to text content.
 * @param {any} str - The input value to sanitize.
 * @returns {string} The sanitized string.
 */
const sanitize = (str) => {
    if (str === null || typeof str === 'undefined') return "";
    const temp = document.createElement('div');
    temp.textContent = String(str);
    return temp.innerHTML;
};

/**
 * Formats ISO date strings into human-readable relative time or full date.
 */
const TimeAgo = {
  MINUTE: 60, HOUR: 3600, DAY: 86400, WEEK: 604800, MONTH: 2592000, YEAR: 31536000,
  format: (isoString) => {
    if (!isoString) return 'N/A';
    try {
      const date = new Date(isoString);
      const seconds = Math.floor((new Date() - date) / 1000);
      if (isNaN(seconds) || seconds < 0) {
        return TimeAgo.formatFullDate(date);
      }
      if (seconds < 2) return "just now";
      if (seconds < TimeAgo.MINUTE) return `${seconds} sec${seconds > 1 ? 's' : ''} ago`;
      if (seconds < TimeAgo.HOUR) return `${Math.floor(seconds / TimeAgo.MINUTE)} min${Math.floor(seconds / TimeAgo.MINUTE) > 1 ? 's' : ''} ago`;
      if (seconds < TimeAgo.DAY) return `${Math.floor(seconds / TimeAgo.HOUR)} hr${Math.floor(seconds / TimeAgo.HOUR) > 1 ? 's' : ''} ago`;
      if (seconds < TimeAgo.DAY * 2) return "Yesterday";
      if (seconds < TimeAgo.WEEK) return `${Math.floor(seconds / TimeAgo.DAY)} days ago`;
      return TimeAgo.formatFullDate(date, true);
    } catch (e) {
      console.error("Date Format Error (TimeAgo):", isoString, e);
      return 'Invalid Date';
    }
  },
  formatFullDate: (date, short = false) => {
      if (!(date instanceof Date) || isNaN(date.getTime())) return 'Invalid Date';
      const optsDate = short
        ? { year: '2-digit', month: 'numeric', day: 'numeric' }
        : { year: 'numeric', month: 'short', day: 'numeric' };
      const optsTime = { hour: 'numeric', minute: '2-digit', hour12: true };
      try {
        return `${date.toLocaleDateString(undefined, optsDate)}${short ? '' : ', ' + date.toLocaleTimeString(undefined, optsTime)}`;
      } catch (e) {
          console.error("toLocaleDateString/Time failed:", e);
          return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
      }
  }
};

/**
 * Extracts file size (e.g., "1.2 GB") from a string and returns structured data.
 * @param {string} inputString - The string to parse (can be filename or dedicated size field).
 * @returns {object} Object with value, unit, display string, and bytes.
 */
function extractSizeData(inputString) {
    if (!inputString) return { value: 0, unit: '', display: 'N/A', bytes: 0 };
    // Regex to find size like (1.2 GB) or [200MB] or just "1.2GB"
    const r = /(?<size>[\d.]+)\s?(?<unit>GB|MB)/i;
    const m = String(inputString).match(r);
    if (m?.groups?.size && m?.groups?.unit) {
        const value = parseFloat(m.groups.size);
        const unit = m.groups.unit.toUpperCase();
        if (!isNaN(value)) {
            const bytes = unit === 'GB' ? value * 1024 * 1024 * 1024 : value * 1024 * 1024;
            return { value: value, unit: unit, display: `${value} ${unit}`, bytes: isNaN(bytes) ? 0 : bytes };
        }
    }
    // If not found in standard format, return N/A
    return { value: 0, unit: '', display: 'N/A', bytes: 0 };
}

/**
 * Attempts to determine the MIME type from a URL's file extension.
 * @param {string} url - The URL string.
 * @returns {string} The guessed MIME type or a generic 'video/*'.
 */
function getMimeTypeFromUrl(url) {
    if (!url) return 'video/*';
    const m = url.match(/\.([a-zA-Z0-9]+)(?:[?#]|$)/);
    if (!m) return 'video/*';
    const ext = m[1].toLowerCase();
    const mimeMap = {
        'mkv': 'video/x-matroska', 'mp4': 'video/mp4', 'mov': 'video/quicktime',
        'avi': 'video/x-msvideo', 'webm': 'video/webm', 'wmv': 'video/x-ms-wmv',
        'flv': 'video/x-flv', 'ts': 'video/mp2t', 'm4v': 'video/x-m4v',
        'ogv': 'video/ogg'
    };
    return mimeMap[ext] || 'video/*';
}

/**
 * Handles errors during HTML5 video playback.
 * @param {Event} event - The error event object.
 */
function handleVideoError(event) {
    console.error("HTML5 Video Error:", event, videoElement?.error);
    let msg = "An unknown error occurred while trying to play the video.";
    if (videoElement?.error) {
        switch (videoElement.error.code) {
            case MediaError.MEDIA_ERR_ABORTED: msg = 'Playback was aborted by the user or script.'; break;
            case MediaError.MEDIA_ERR_NETWORK: msg = 'A network error caused the video download to fail part-way.'; break;
            case MediaError.MEDIA_ERR_DECODE: msg = 'The video playback was aborted due to a corruption problem or because the video used features your browser did not support (e.g., unsupported codec).'; break;
            case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED: msg = 'The video could not be loaded, either because the server or network failed or because the format is not supported by your browser.'; break;
            default: msg = `An unknown video error occurred (Code: ${videoElement.error.code}).`; break;
        }
    }
    if (audioWarningDiv) {
        audioWarningDiv.innerHTML = `<strong>Playback Error:</strong> ${sanitize(msg)} <br>Consider using 'Copy URL' with an external player like VLC or MX Player, or try the 'Open Externally' button if available (Android).`;
        audioWarningDiv.style.display = 'block';
    }
}
// Attach the error handler to the video element
if (videoElement) { videoElement.addEventListener('error', handleVideoError); }


/**
 * Extracts a quality indicator (e.g., "1080p", "BluRay") from a filename.
 */
function extractQualityFromFilename(filename) {
    if (!filename) return null;
    const patterns = [
        /(?:^|\.|\[|\(|\s|_|-)((?:4k|2160p|1080p|720p|480p))(?=$|\.|\]|\)|\s|_|-)/i,
        /(?:^|\.|\[|\(|\s|_-)(WEB-?DL|WEBRip|BluRay|BDRip|BRRip|HDTV|HDRip|DVDrip|DVDScr|HDCAM|HC|TC|TS|CAM)(?=$|\.|\]|\)|\s|_|-)/i,
        /(?:^|\.|\[|\(|\s|_-)(HDR|DV|Dolby.?Vision|HEVC|x265)(?=$|\.|\]|\)|\s|_|-)/i
    ];
    let foundQuality = null;
    for (const regex of patterns) {
        const match = filename.match(regex);
        if (match && match[1]) {
            let quality = match[1].toUpperCase();
            quality = quality.replace(/WEB-?DL/i, 'WEBDL');
            quality = quality.replace(/BLURAY/i, 'BluRay');
            quality = quality.replace(/DVDRIP/i, 'DVD');
            quality = quality.replace(/DOLBY.?VISION/i, 'Dolby Vision');
            if (quality === '2160P') quality = '4K';

            if (patterns.indexOf(regex) < 2) return quality;
            if (patterns.indexOf(regex) === 2 && !foundQuality) foundQuality = quality;
        }
    }
    return foundQuality;
}

/**
 * Normalizes text for searching (lowercase, removes specific punctuation, collapses whitespace).
 */
function normalizeTextForSearch(text) {
    if (!text) return "";
    return String(text)
        .toLowerCase()
        .replace(/[.\-_\(\)\[\]]/g, '')
        .replace(/\s+/g, ' ')
        .trim();
}


/**
 * Preprocesses raw movie data fetched from the source.
 * Adds calculated fields like display filename, size, quality, timestamp, and search text.
 * Uses the keys provided by the backend API.
 * @param {object} movie - The raw movie object from the data source.
 * @returns {object} The processed movie object with added fields.
 */
function preprocessMovieData(movie) {
    const processed = {}; // Create a new object to avoid modifying the original

    // Directly map keys from backend that don't need complex processing
    processed.id = movie.id || null; // Use null if missing
    processed.url = movie.url || null;
    processed.telegramLink = movie.telegramLink || null;
    processed.gdflixLink = movie.gdflixLink || null;
    processed.hubcloudLink = movie.hubcloudLink || null;
    processed.filepressLink = movie.filepressLink || null;
    processed.gdtotLink = movie.gdtotLink || null;
    processed.languages = movie.languages || null;

    // 1. Determine Display Filename
    processed.filenameSource = 'sheet';
    processed.displayFilename = sanitize(movie.filename || ''); // Start with sheet value
    if (!processed.displayFilename && movie.url) { // Fallback to URL derivation
        try {
            const urlObject = new URL(movie.url);
            let potentialFilename = '';
            const pathParam = urlObject.searchParams.get('path');
            if (pathParam) {
                const pathSegments = pathParam.split('/').filter(Boolean);
                if (pathSegments.length > 0) potentialFilename = decodeURIComponent(pathSegments[pathSegments.length - 1]);
            }
            if (!potentialFilename && urlObject.pathname && urlObject.pathname !== '/') {
                const pathSegments = urlObject.pathname.split('/').filter(Boolean);
                if (pathSegments.length > 0 && pathSegments[pathSegments.length - 1].includes('.')) {
                    potentialFilename = decodeURIComponent(pathSegments[pathSegments.length - 1]);
                }
            }
            if (potentialFilename) {
                processed.displayFilename = sanitize(potentialFilename);
                processed.filenameSource = 'url';
            }
        } catch (e) { console.warn("URL parsing failed for filename extraction:", movie.url, e); }
    }
    if (!processed.displayFilename) { // Final fallback to placeholder
        processed.displayFilename = `File (ID: ${sanitize(processed.id || 'N/A')})`;
        processed.filenameSource = 'placeholder';
    }
     // Store original sheet filename if different from display one (for info row)
     if (processed.displayFilename !== sanitize(movie.filename || '')) {
        processed.originalFilename = movie.filename || null;
     } else {
        processed.originalFilename = null;
     }

    // 2. Determine Size
    processed.sizeData = { display: 'N/A', bytes: 0 }; // Initialize
    if (movie.size && String(movie.size).toLowerCase() !== 'n/a') {
         const explicitSize = extractSizeData(String(movie.size)); // Try parsing sheet 'size' value directly
         if (explicitSize && explicitSize.bytes > 0) processed.sizeData = explicitSize;
    }
    // If no valid size from sheet, try extracting from display filename
    if (processed.sizeData.bytes === 0 && processed.filenameSource !== 'placeholder') {
        const extractedSize = extractSizeData(processed.displayFilename);
        if (extractedSize && extractedSize.bytes > 0) processed.sizeData = extractedSize;
    }

    // 3. Determine Quality
    processed.displayQuality = sanitize(movie.quality || 'N/A'); // Start with sheet 'quality'
    if ((!movie.quality || String(movie.quality).toLowerCase() === 'n/a') && processed.filenameSource !== 'placeholder') {
        const extractedQuality = extractQualityFromFilename(processed.displayFilename);
        if (extractedQuality) processed.displayQuality = sanitize(extractedQuality);
    }
    if (processed.displayQuality && processed.displayQuality !== 'N/A') {
        uniqueQualities.add(processed.displayQuality); // Add valid quality to set
    }

    // 4. Parse Last Updated Timestamp (Backend sends ISO string)
    processed.lastUpdated = movie.lastUpdated || null; // Store the ISO string
    processed.lastUpdatedTimestamp = 0;
    if (processed.lastUpdated) {
        try {
            const parsedDate = new Date(processed.lastUpdated);
            if (!isNaN(parsedDate.getTime())) {
                processed.lastUpdatedTimestamp = parsedDate.getTime();
            } else {
                 console.warn("Invalid date format received from backend for lastUpdated:", processed.lastUpdated);
            }
        } catch (e) { console.warn("Error parsing lastUpdated date from backend:", processed.lastUpdated, e); }
    }

    // 5. Parse Numeric ID
    processed.numericId = Infinity;
    if (processed.id) {
        const parsedId = parseInt(String(processed.id).replace(/\D/g, ''), 10);
        if (!isNaN(parsedId)) processed.numericId = parsedId;
    }

    // 6. Create Normalized Search Text
    processed.searchText = normalizeTextForSearch(`${processed.id || ''} ${processed.displayFilename}`);

    return processed; // Return the processed movie object
}


/**
 * Generates the HTML string for a single movie row and its corresponding action row.
 * @param {object} movie - The processed movie data object.
 * @param {number} index - The index of the movie (used for unique IDs).
 * @param {string} context - A prefix for IDs ('upd' for updates, 'rec' for recent).
 * @returns {string} The combined HTML string for the main and action rows.
 */
function createMovieRowsHTML(movie, index, context) {
    const uniqueIdPart = movie.id ? String(movie.id).replace(/[^a-zA-Z0-9-_]/g, '') : `gen-${index}`;
    const actionRowId = `${context}-actions-${uniqueIdPart}`;

    const displayFilename = movie.displayFilename;
    const displaySize = movie.sizeData.display;
    const displayQuality = movie.displayQuality;

    const streamTitle = displayFilename
        .split(/[\.\(\[]/)[0]
        .replace(/[_ ]+/g, ' ').trim()
        + (displayQuality !== 'N/A' ? ` (${displayQuality})` : '');

    const formattedDateRelative = TimeAgo.format(movie.lastUpdated);
    const formattedDateFull = movie.lastUpdatedTimestamp > 0 ? TimeAgo.formatFullDate(new Date(movie.lastUpdatedTimestamp)) : 'N/A';

    let hdrLogoHtml = '';
    let fourkLogoHtml = '';
    const lowerFilename = displayFilename.toLowerCase();
    if (displayQuality === '4K' || lowerFilename.includes('2160p') || lowerFilename.includes('.4k.')) {
        fourkLogoHtml = `<img src="${config.FOURK_LOGO_URL}" alt="4K" class="quality-logo fourk-logo" title="4K Ultra HD" />`;
    }
    if (displayQuality.includes('HDR') || displayQuality.includes('DOLBY VISION') || displayQuality === 'DV' ||
        lowerFilename.includes('hdr') || lowerFilename.includes('dolby.vision') || lowerFilename.includes('.dv.')) {
        hdrLogoHtml = `<img src="${config.HDR_LOGO_URL}" alt="HDR/DV" class="quality-logo hdr-logo" title="HDR / Dolby Vision Content" />`;
    }

    const escapedStreamTitle = streamTitle.replace(/'/g, "\\'");
    const escapedFilename = displayFilename.replace(/'/g, "\\'");

    const colspanValue = 6;

    // --- Main Data Row HTML ---
    const mainRowHTML = `
        <tr class="movie-data-row">
            <td class="col-id">${sanitize(movie.id || 'N/A')}</td>
            <td class="col-filename" title="Click to view details: ${displayFilename}" onclick="toggleActions(this, '${actionRowId}')">
                ${displayFilename}${fourkLogoHtml}${hdrLogoHtml}
            </td>
            <td class="col-size">${displaySize}</td>
            <td class="col-quality">${displayQuality}</td>
            <td class="col-updated" title="${formattedDateFull}">${formattedDateRelative}</td>
            <td class="col-view"><button class="button view-button" onclick="toggleActions(this, '${actionRowId}')">View</button></td>
        </tr>
    `;

    // --- Action Buttons HTML (Conditional) ---
    let actionButtonsHTML = '';
    if (movie.url) {
        actionButtonsHTML += `<button class="button play-button" onclick="streamVideo('${escapedStreamTitle}', '${sanitize(movie.url)}', '${escapedFilename}')">Play here</button>`;
        actionButtonsHTML += `<a class="button download-button" href="${sanitize(movie.url)}" download="${displayFilename}" target="_blank" rel="noopener noreferrer">Direct Download</a>`;
        actionButtonsHTML += `<button class="button vlc-button" onclick="copyVLCLink(this, '${sanitize(movie.url)}')">Copy URL (for VLC/MX)</button>`;
        if (navigator.userAgent.toLowerCase().includes("android")) {
             actionButtonsHTML += `<button class="button intent-button" onclick="openWithIntent('${sanitize(movie.url)}')">Open Externally (Android)</button>`;
        }
    }
    if (movie.telegramLink) actionButtonsHTML += `<a class="button telegram-button" href="${sanitize(movie.telegramLink)}" target="_blank" rel="noopener noreferrer">Telegram File</a>`;

    // Conditional GDFLIX button text
    if (movie.gdflixLink) {
        let gdflixButtonText = "GDFLIX";
        if (movie.gdflixLink.includes('/pack/')) {
            gdflixButtonText = "GDFLIX (pack)";
        }
        actionButtonsHTML += `<a class="button gdflix-button" href="${sanitize(movie.gdflixLink)}" target="_blank" rel="noopener noreferrer">${gdflixButtonText}</a>`;
    }

    // --- ADDED BUTTONS FOR NEW LINKS ---
    if (movie.hubcloudLink) actionButtonsHTML += `<a class="button hubcloud-button" href="${sanitize(movie.hubcloudLink)}" target="_blank" rel="noopener noreferrer">HubCloud</a>`;
    if (movie.filepressLink) actionButtonsHTML += `<a class="button filepress-button" href="${sanitize(movie.filepressLink)}" target="_blank" rel="noopener noreferrer">Filepress</a>`;
    if (movie.gdtotLink) actionButtonsHTML += `<a class="button gdtot-button" href="${sanitize(movie.gdtotLink)}" target="_blank" rel="noopener noreferrer">GDToT</a>`;
    // --- END OF ADDED BUTTONS ---

    if (!actionButtonsHTML) {
        actionButtonsHTML = '<span style="color: var(--text-muted); font-style: italic; text-align: center; width: 100%; display: block; padding: 10px 0;">No stream/download actions available</span>';
    }

    // --- Action Row HTML ---
    const actionRowHTML = `
        <tr id="${actionRowId}" class="action-row" style="display: none;">
            <td colspan="${colspanValue}">
                <div class="action-info">
                    <span class="info-item"><strong>Filename:</strong> ${displayFilename}</span>
                    <span class="info-item"><strong>Quality:</strong> ${displayQuality} ${fourkLogoHtml} ${hdrLogoHtml}</span>
                    <span class="info-item"><strong>Size:</strong> ${displaySize}</span>
                    <span class="info-item"><strong>Language:</strong> ${sanitize(movie.languages || 'N/A')}</span> <!-- Added Languages -->
                    <span class="info-item"><strong>Updated:</strong> ${formattedDateFull} (${formattedDateRelative})</span>
                    ${movie.originalFilename
                       ? `<span class="info-item"><strong>Original Name:</strong> ${sanitize(movie.originalFilename)}</span>`
                       : ''}
                </div>
                <div class="action-buttons-container">
                   ${actionButtonsHTML}
                </div>
                <!-- Video player container will be moved into this TD dynamically -->
            </td>
        </tr>`;

    return mainRowHTML + actionRowHTML;
}

/**
 * Renders the Updates and Recent Movies tables based on the current state.
 */
function renderTables() {
    const now = Date.now();
    const twentyFourHoursAgo = now - (24 * 60 * 60 * 1000);

    // --- Render Updates Table ---
    let updatesHtml = '';
    let updatesFound = false;
    let updateIndex = 0;
    const sortedOriginalDataForUpdates = [...allMovieData].sort((a, b) => b.lastUpdatedTimestamp - a.lastUpdatedTimestamp);
    sortedOriginalDataForUpdates.forEach((movie) => {
        // Check if updated recently AND has minimal required data (ID and some link/content)
        if (movie.lastUpdatedTimestamp >= twentyFourHoursAgo &&
            movie.id && (movie.url || movie.telegramLink || movie.gdflixLink || movie.hubcloudLink || movie.filepressLink || movie.gdtotLink || movie.filenameSource !== 'placeholder') ) {
                updatesHtml += createMovieRowsHTML(movie, updateIndex, 'upd');
                updatesFound = true;
                updateIndex++;
        }
    });
    if (updatesTableBody) updatesTableBody.innerHTML = updatesFound ? updatesHtml : '<tr><td colspan="6" class="status-message">No updates in the last 24 hours.</td></tr>';
    if (updatesSection) updatesSection.style.display = currentState.searchTerm ? 'none' : 'block';

    // --- Render Recent Movies Table (Paginated) ---
    let movieHtml = '';
    const totalItems = filteredAndSortedData.length;
    const totalPages = Math.ceil(totalItems / config.ITEMS_PER_PAGE);

    if (currentState.currentPage < 1) currentState.currentPage = 1;
    if (currentState.currentPage > totalPages && totalPages > 0) currentState.currentPage = totalPages;
    if (totalItems === 0) currentState.currentPage = 1;

    const startIndex = (currentState.currentPage - 1) * config.ITEMS_PER_PAGE;
    const endIndex = Math.min(startIndex + config.ITEMS_PER_PAGE, totalItems);
    const pageData = filteredAndSortedData.slice(startIndex, endIndex);

    if (totalItems === 0) {
        if (movieTableBody) movieTableBody.innerHTML = `<tr><td colspan="6" class="status-message">${currentState.searchTerm || currentState.qualityFilter ? 'No movies found matching your criteria.' : 'Loading movies or no movies listed yet.'}</td></tr>`;
        if (paginationControlsContainer) paginationControlsContainer.style.display = 'none';
    } else {
        pageData.forEach((movie, index) => movieHtml += createMovieRowsHTML(movie, startIndex + index, 'rec'));
        if (movieTableBody) movieTableBody.innerHTML = movieHtml;
        renderPaginationControls(totalItems, totalPages);
        if (paginationControlsContainer) paginationControlsContainer.style.display = 'block';
    }

    updateSortIndicators();
    updateFilterIndicator();

    // --- Handle Active Action Row State ---
    if (activeActionRow && activeActionRow.style.display !== 'none') {
        const mainRow = activeActionRow.previousElementSibling;
        const isMainRowVisible = (movieTableBody?.contains(mainRow) || updatesTableBody?.contains(mainRow));
        if (!isMainRowVisible) {
             closePlayer();
             activeActionRow.style.display = 'none';
             activeActionRow = null;
        }
    } else if (activeActionRow && activeActionRow.style.display === 'none') {
         activeActionRow = null;
         closePlayerIfNeeded();
    }
}


/**
 * Renders the pagination controls based on total items and current page.
 */
function renderPaginationControls(totalItems, totalPages) {
    if (!paginationControlsContainer) return;
    paginationControlsContainer.innerHTML = '';
    if (totalPages <= 1) {
        paginationControlsContainer.style.display = 'none';
        return;
    }

    let paginationHTML = '';
    const currentPage = currentState.currentPage;

    // Previous Button
    paginationHTML += `<button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled title="Already on first page"' : 'title="Go to previous page"'}>« Prev</button>`;

    // Page Number Buttons (with ellipsis logic)
    const maxPagesToShow = 5;
    const halfPages = Math.floor(maxPagesToShow / 2);

    if (totalPages <= maxPagesToShow + 2) { // Show all
        for (let i = 1; i <= totalPages; i++) {
            paginationHTML += (i === currentPage) ? `<span class="current-page">${i}</span>` : `<button onclick="changePage(${i})" title="Go to page ${i}">${i}</button>`;
        }
    } else { // Show ellipsis
        let startPage = Math.max(2, currentPage - halfPages);
        let endPage = Math.min(totalPages - 1, currentPage + halfPages);

        if (currentPage <= halfPages + 1) {
            endPage = Math.min(totalPages - 1, maxPagesToShow);
        }
        if (currentPage >= totalPages - halfPages) {
            startPage = Math.max(2, totalPages - maxPagesToShow + 1);
        }

        // First page
        paginationHTML += (1 === currentPage) ? `<span class="current-page">1</span>` : `<button onclick="changePage(1)" title="Go to page 1">1</button>`;
        if (startPage > 2) paginationHTML += `<span class="page-info" title="Skipped pages">...</span>`;

        // Middle pages
        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += (i === currentPage) ? `<span class="current-page">${i}</span>` : `<button onclick="changePage(${i})" title="Go to page ${i}">${i}</button>`;
        }

        // Ellipsis before last page?
        if (endPage < totalPages - 1) paginationHTML += `<span class="page-info" title="Skipped pages">...</span>`;
        // Last page
        paginationHTML += (totalPages === currentPage) ? `<span class="current-page">${totalPages}</span>` : `<button onclick="changePage(${totalPages})" title="Go to page ${totalPages}">${totalPages}</button>`;
    }

    // Next Button
    paginationHTML += `<button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled title="Already on last page"' : 'title="Go to next page"'}>Next »</button>`;

    paginationControlsContainer.innerHTML = paginationHTML;
    paginationControlsContainer.style.display = 'block';
}

/**
 * Applies current search, filter, and sort criteria to the data, then renders the table.
 */
function applyUserActions() {
    const normalizedSearch = normalizeTextForSearch(currentState.searchTerm);
    const searchKeywords = normalizedSearch ? normalizedSearch.split(' ').filter(Boolean) : [];

    filteredAndSortedData = allMovieData.filter(movie => {
        if (currentState.qualityFilter && movie.displayQuality !== currentState.qualityFilter) {
            return false;
        }
        if (searchKeywords.length > 0 && !searchKeywords.every(keyword => movie.searchText.includes(keyword))) {
            return false;
        }
        movie.isExactMatch = searchKeywords.length > 0 && movie.searchText.includes(normalizedSearch);
        return true;
    });

    const sortKey = currentState.sortColumn;
    const direction = currentState.sortDirection === 'asc' ? 1 : -1;

    filteredAndSortedData.sort((a, b) => {
        if (searchKeywords.length > 0 && a.isExactMatch !== b.isExactMatch) {
            return a.isExactMatch ? -1 : 1;
        }

        let valA, valB;
        switch (sortKey) {
            case 'id': valA = a.numericId; valB = b.numericId; break;
            case 'filename': valA = a.displayFilename.toLowerCase(); valB = b.displayFilename.toLowerCase(); break;
            case 'size': valA = a.sizeData.bytes; valB = b.sizeData.bytes; break;
            case 'quality': valA = a.displayQuality.toLowerCase(); valB = b.displayQuality.toLowerCase(); break;
            case 'lastUpdated': default: valA = a.lastUpdatedTimestamp; valB = b.lastUpdatedTimestamp; break;
        }

        const aIsLess = (valA === null || typeof valA === 'undefined') || (valA < valB && valB !== null && typeof valB !== 'undefined');
        const bIsLess = (valB === null || typeof valB === 'undefined') || (valB < valA && valA !== null && typeof valA !== 'undefined');

        if (aIsLess) return -1 * direction;
        if (bIsLess) return 1 * direction;

        // Secondary sort by ID desc for stability
        if (b.numericId < a.numericId) return -1;
        if (b.numericId > a.numericId) return 1;

        return 0;
    });

    renderTables();
    saveStateToLocalStorage();
}


/**
 * Handles clicks on sortable table headers.
 */
function handleSort(event) {
    const header = event.target.closest('th.sortable');
    if (!header) return;
    const sortKey = header.dataset.sortKey;
    if (!sortKey) return;

    if (currentState.sortColumn === sortKey) {
        currentState.sortDirection = currentState.sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        currentState.sortColumn = sortKey;
        currentState.sortDirection = ['filename', 'quality'].includes(sortKey) ? 'asc' : 'desc';
    }

    currentState.currentPage = 1;
    closePlayerIfNeeded();
    applyUserActions();
}

/**
 * Updates the visual indicators (arrows) on table headers for sorting.
 */
function updateSortIndicators() {
    if (!movieTableHead) return;
    movieTableHead.querySelectorAll('th.sortable').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
        if (th.dataset.sortKey === currentState.sortColumn) {
            th.classList.add(currentState.sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
            th.setAttribute('aria-sort', currentState.sortDirection === 'asc' ? 'ascending' : 'descending');
        } else {
            th.removeAttribute('aria-sort');
        }
    });
}

/**
 * Updates the visual style of the quality filter select element.
 */
function updateFilterIndicator() {
    if (!qualityFilterSelect) return;
    qualityFilterSelect.classList.toggle('filter-active', !!currentState.qualityFilter);
}


/**
 * Changes the current page and re-renders the table.
 */
function changePage(newPage) {
    const totalItems = filteredAndSortedData.length;
    const totalPages = Math.ceil(totalItems / config.ITEMS_PER_PAGE);

    if (newPage >= 1 && newPage <= totalPages && newPage !== currentState.currentPage) {
        currentState.currentPage = newPage;
        closePlayerIfNeeded();
        renderTables();
        saveStateToLocalStorage();

        const tableElement = document.getElementById('movieTable') || document.getElementById('updatesTable');
        if (tableElement) {
            const headerElement = tableElement.querySelector('thead');
            const headerHeight = headerElement ? headerElement.offsetHeight : 0;
            const scrollOffset = 20;
            const elementPosition = tableElement.getBoundingClientRect().top + window.pageYOffset;
            const offsetPosition = elementPosition - headerHeight - scrollOffset;

            window.scrollTo({ top: offsetPosition, behavior: 'smooth' });
        }
    }
}


/**
 * Toggles the visibility of the action row associated with a clicked element.
 */
function toggleActions(clickedElement, targetRowId) {
    const targetRow = document.getElementById(targetRowId);
    if (!targetRow) return;

    let mainRowElement = clickedElement.closest('tr');
    if (!mainRowElement) return;
    let buttonElement = mainRowElement.querySelector('.view-button');
    if (!buttonElement) return;

    const isCurrentlyVisible = targetRow.style.display !== 'none';

    if (!isCurrentlyVisible && videoContainer?.style.display === 'flex' && activeActionRow !== targetRow) {
        closePlayer();
    }

    if (activeActionRow && activeActionRow !== targetRow && activeActionRow.style.display !== 'none') {
        activeActionRow.style.display = 'none';
        const otherMainRow = activeActionRow.previousElementSibling;
        const otherButton = otherMainRow?.querySelector('.view-button');
        if (otherButton) {
            otherButton.textContent = 'View';
            otherButton.setAttribute('aria-expanded', 'false');
        }
        if (videoContainer?.parentElement === activeActionRow.querySelector('td')) {
            closePlayer();
        }
    }

    if (isCurrentlyVisible) {
        targetRow.style.display = 'none';
        buttonElement.textContent = 'View';
        buttonElement.setAttribute('aria-expanded', 'false');
        activeActionRow = null;
        closePlayer();
    } else {
        targetRow.style.display = 'table-row';
        buttonElement.textContent = 'Hide';
        buttonElement.setAttribute('aria-expanded', 'true');
        activeActionRow = targetRow;

        const actionCell = targetRow.querySelector('td');
        if (actionCell && videoContainer?.parentElement !== actionCell) {
             if (videoElement && videoElement.hasAttribute('src')) {
                 videoElement.pause();
                 videoElement.removeAttribute('src');
                 videoElement.load();
             }
             if (videoContainer) videoContainer.style.display = 'none';
             if (videoContainer) actionCell.appendChild(videoContainer);
        } else if (!actionCell) {
            console.error("Could not find action cell to move player into:", targetRowId);
        }

        setTimeout(() => {
            const headerElement = document.querySelector('#movieTable thead') || document.querySelector('#updatesTable thead');
            const headerHeight = headerElement ? headerElement.offsetHeight : 0;
            const elementRect = mainRowElement.getBoundingClientRect();
            const absoluteElementTop = elementRect.top + window.pageYOffset;
            const scrollOffset = 10;
            const offsetPosition = absoluteElementTop - headerHeight - scrollOffset;
            window.scrollTo({ top: offsetPosition, behavior: 'smooth' });
        }, 100);
    }
}


/**
 * Starts streaming a video in the inline player within the active action row.
 */
 function streamVideo(title, url, filenameForAudioCheck) {
     if (!videoContainer || !videoElement || !activeActionRow) {
         console.error("Cannot stream: player/element/active row missing.");
         return;
     }

      const actionCell = activeActionRow.querySelector('td');
      if (!actionCell) { console.error("Cannot stream: action cell not found."); return; }
      if (videoContainer.parentElement !== actionCell) {
          console.warn("Video container not in expected cell. Moving.");
           if(videoElement && videoElement.hasAttribute('src')) {
               videoElement.pause(); videoElement.removeAttribute('src'); videoElement.load();
           }
           actionCell.appendChild(videoContainer);
      }

     if (audioWarningDiv) { audioWarningDiv.style.display = 'none'; audioWarningDiv.innerHTML = ''; }
     if (audioTrackSelect) { audioTrackSelect.innerHTML = ''; audioTrackSelect.style.display = 'none'; }
     if (copyFeedbackSpan) copyFeedbackSpan.classList.remove('show');

     const savedVolume = localStorage.getItem(config.PLAYER_VOLUME_KEY);
     const savedSpeed = localStorage.getItem(config.PLAYER_SPEED_KEY);
     videoElement.volume = (savedVolume !== null) ? Math.max(0, Math.min(1, parseFloat(savedVolume))) : 1;
     if (volumeSlider) volumeSlider.value = videoElement.volume;
     videoElement.muted = (videoElement.volume === 0);
     videoElement.playbackRate = (savedSpeed !== null) ? parseFloat(savedSpeed) : 1;
     if(playbackSpeedSelect) playbackSpeedSelect.value = String(videoElement.playbackRate);
     updateMuteButton();

     // --- Audio Check ---
     const ddp51Regex = /\bDDP?([ ._-]?5\.1)?\b/i;
     const advancedAudioRegex = /\b(DTS|ATMOS|TrueHD)\b/i;
     const multiAudioHintRegex = /\b(Multi|Dual)[ ._-]?Audio\b/i;
     let warningText = "";
      if (filenameForAudioCheck) {
          const lowerFilename = filenameForAudioCheck.toLowerCase();
          if (ddp51Regex.test(lowerFilename)) {
              warningText = "<strong>Audio Note:</strong> Dolby Digital Plus (DDP) audio might not be supported in this browser. Use 'Copy URL' or 'Open Externally' if you experience sound issues.";
          } else if (advancedAudioRegex.test(lowerFilename)) {
              warningText = "<strong>Audio Note:</strong> DTS/Atmos/TrueHD audio is likely unsupported in this browser. Use 'Copy URL' or 'Open Externally' for playback with compatible players.";
          } else if (multiAudioHintRegex.test(lowerFilename)) {
              warningText = "<strong>Audio Note:</strong> This file may contain multiple audio tracks. Use the audio track selector below (if available after loading) or an external player.";
          }
      }
      if (warningText && audioWarningDiv) {
          audioWarningDiv.innerHTML = warningText;
          audioWarningDiv.style.display = 'block';
      }

     // --- Setup and Play ---
     if (videoTitle) videoTitle.innerText = title;
     if (vlcText) vlcText.innerText = url;
     if (vlcBox) vlcBox.style.display = 'block';
     videoElement.src = url;
     videoElement.load();

     videoElement.play().catch(e => {
          console.log("Autoplay prevented or failed:", e.message);
     });
     videoContainer.style.display = 'flex';

     setTimeout(() => {
         videoContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
     }, 150);
 }

/**
 * Closes the inline video player, stops playback, resets its state, and moves it back.
 */
 function closePlayer() {
    if (!videoContainer || !videoElement) return;

    const wasPlaying = videoContainer.style.display !== 'none';

    try {
        const fsElement = document.fullscreenElement || document.webkitFullscreenElement;
        if (fsElement && (fsElement === videoElement || fsElement === videoContainer)) {
            if (document.exitFullscreen) document.exitFullscreen();
            else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
        }
    } catch(err) { console.error("Error exiting fullscreen:", err); }

    videoElement.pause();
    videoElement.removeAttribute('src');
    videoElement.load();

    videoContainer.style.display = 'none';
    if (vlcBox) vlcBox.style.display = 'none';
    if (audioWarningDiv) { audioWarningDiv.style.display = 'none'; audioWarningDiv.innerHTML = ''; }
    if (audioTrackSelect) { audioTrackSelect.innerHTML = ''; audioTrackSelect.style.display = 'none'; }
    if (copyFeedbackSpan) copyFeedbackSpan.classList.remove('show');
    if (videoTitle) videoTitle.innerText = '';

    // Move player container back to main container
     if (container && videoContainer.parentElement !== container) {
        if (document.body.contains(container)) {
             container.appendChild(videoContainer);
        } else {
             console.warn("Main container #cinemaghar-container not found, cannot move player back.");
        }
     }

     // Reset view button if corresponding row was active
     if (wasPlaying && activeActionRow && activeActionRow.style.display !== 'none') {
         const actionCell = activeActionRow.querySelector('td');
         // Check if player was inside this row's cell when closed (safety check)
         if (actionCell && videoContainer.parentElement === actionCell) {
              const viewButton = activeActionRow.previousElementSibling?.querySelector('.view-button');
              if (viewButton && viewButton.textContent === 'Hide') {
                  viewButton.textContent = 'View';
                  viewButton.setAttribute('aria-expanded', 'false');
              }
         }
     }

     // Ensure fullscreen class is removed
     if (videoContainer.classList.contains('is-fullscreen')) {
        videoContainer.classList.remove('is-fullscreen');
     }
 }

/** Utility to close the player only if it's currently visible. */
function closePlayerIfNeeded() {
    if (videoContainer?.style.display === 'flex') {
         closePlayer();
    }
}

// --- Player Control Functions ---
function seekVideo(seconds) { if (videoElement) videoElement.currentTime += seconds; }
function togglePlayPause() {
    if (!videoElement) return;
    if (videoElement.paused || videoElement.ended) {
        videoElement.play().catch(e => console.log("Play error:", e.message));
    } else { videoElement.pause(); }
}
function toggleMute() { if (videoElement) videoElement.muted = !videoElement.muted; }
function updateMuteButton() {
    if (!videoElement || !muteButton) return;
    const isMuted = videoElement.muted || videoElement.volume === 0;
    muteButton.textContent = isMuted ? "Unmute" : "Mute";
    muteButton.setAttribute('aria-pressed', String(isMuted));
    if (volumeSlider) {
        volumeSlider.style.opacity = isMuted ? '0.5' : '1';
        volumeSlider.disabled = isMuted;
        if (!isMuted && videoElement.volume === 0) {
             const defaultUnmuteVolume = 0.5;
             videoElement.volume = defaultUnmuteVolume;
             volumeSlider.value = defaultUnmuteVolume;
        }
    }
}
function setVolume(value) {
    if (videoElement) {
        const newVolume = parseFloat(value);
        videoElement.volume = newVolume;
        videoElement.muted = (newVolume === 0);
    }
}
function setPlaybackSpeed(value) { if (videoElement) videoElement.playbackRate = parseFloat(value); }
function toggleFullscreen() {
    const elementToMakeFullscreen = videoContainer;
    if (!elementToMakeFullscreen) return;
    const fsElement = document.fullscreenElement || document.webkitFullscreenElement;

    try {
        if (!fsElement) {
            if (elementToMakeFullscreen.requestFullscreen) elementToMakeFullscreen.requestFullscreen();
            else if (elementToMakeFullscreen.webkitRequestFullscreen) elementToMakeFullscreen.webkitRequestFullscreen();
        } else {
            if (document.exitFullscreen) document.exitFullscreen();
            else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
        }
    } catch (err) {
        console.error("Fullscreen API error:", err);
        alert("Could not enter/exit fullscreen mode.");
    }
}

// --- Fullscreen Change Handler ---
function handleFullscreenChange() {
    const isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement);
    if (!videoContainer) return;
    videoContainer.classList.toggle('is-fullscreen', isFullscreen);
    console.log("Fullscreen state changed. Is fullscreen:", isFullscreen);
}

 // --- Event Listeners for Player State ---
 if(videoElement) {
     videoElement.addEventListener('volumechange', () => {
         if (volumeSlider && parseFloat(volumeSlider.value) !== videoElement.volume) {
              volumeSlider.value = videoElement.volume;
         }
         updateMuteButton();
         try { localStorage.setItem(config.PLAYER_VOLUME_KEY, String(videoElement.volume)); }
         catch (e) { console.warn("Could not save volume to localStorage", e); }
     });
     videoElement.addEventListener('ratechange', () => {
        if(playbackSpeedSelect) playbackSpeedSelect.value = String(videoElement.playbackRate);
         try { localStorage.setItem(config.PLAYER_SPEED_KEY, String(videoElement.playbackRate)); }
         catch (e) { console.warn("Could not save playback speed to localStorage", e); }
     });
     videoElement.addEventListener('loadedmetadata', populateAudioTrackSelector);
 }
 document.addEventListener('fullscreenchange', handleFullscreenChange);
 document.addEventListener('webkitfullscreenchange', handleFullscreenChange);


 // --- Audio Track Selection Logic ---
 function populateAudioTrackSelector() {
      if (!videoElement || typeof videoElement.audioTracks === 'undefined' || !audioTrackSelect) {
          if(audioTrackSelect) audioTrackSelect.style.display = 'none';
          return;
      }
      const tracks = videoElement.audioTracks;
      audioTrackSelect.innerHTML = '';

      if (tracks.length <= 1) {
          audioTrackSelect.style.display = 'none';
          return;
      }

      let hasEnabledTrack = false;
      for (let i = 0; i < tracks.length; i++) { if (tracks[i].enabled) hasEnabledTrack = true; }
      if (!hasEnabledTrack && tracks.length > 0) {
          try { tracks[0].enabled = true; } catch(e) { console.warn("Could not auto-enable first audio track:", e); }
      }

      let preferredTrackIndex = -1;

      for (let i = 0; i < tracks.length; i++) {
          const track = tracks[i];
          const option = document.createElement('option');
          const trackValue = track.id || i;
          option.value = trackValue;

          let label = track.label || `Track ${i + 1}`;
          let languageName = '';
          if (track.language) {
              try {
                  languageName = new Intl.DisplayNames(['en'], { type: 'language' }).of(track.language.split('-')[0]);
                  label += ` (${languageName || track.language})`;
              } catch (e) { label += ` (${track.language})`; }
          }
          option.textContent = label;
          option.selected = track.enabled;
          option.disabled = track.readyState === 'ended';
          audioTrackSelect.appendChild(option);

          if (track.language && track.language.toLowerCase().startsWith('hi')) {
             if (preferredTrackIndex === -1) preferredTrackIndex = i;
          }
          else if (preferredTrackIndex === -1 && (label.toLowerCase().includes('hindi') || (languageName && languageName.toLowerCase() === 'hindi'))) {
              preferredTrackIndex = i;
          }
      }

      if (preferredTrackIndex !== -1) {
          console.log(`Preferred track found at index ${preferredTrackIndex}. Attempting auto-selection.`);
          try {
              let trackChanged = false;
              for (let i = 0; i < tracks.length; i++) {
                   const shouldBeEnabled = (i === preferredTrackIndex);
                   if (tracks[i].enabled !== shouldBeEnabled) {
                       tracks[i].enabled = shouldBeEnabled;
                       trackChanged = true;
                   }
              }
              const preferredTrackValue = tracks[preferredTrackIndex].id || preferredTrackIndex;
              audioTrackSelect.value = preferredTrackValue;
              if (trackChanged) console.log("Successfully auto-selected preferred track.");
          } catch(e) { console.error("Error auto-selecting preferred audio track:", e); }
      } else {
          console.log("No preferred audio track found for auto-selection.");
          for (let i = 0; i < tracks.length; i++) {
              if (tracks[i].enabled) {
                  audioTrackSelect.value = tracks[i].id || i;
                  break;
              }
          }
      }

      audioTrackSelect.style.display = 'inline-block';

       try { if (tracks.onchange === null) tracks.onchange = populateAudioTrackSelector; } // Use onchange as addEventListener might not be supported
       catch(e) { console.warn("Browser might not support 'onchange' on AudioTrackList", e)}
  }

 function changeAudioTrack(selectElement) {
      if (!videoElement || !videoElement.audioTracks) return;
      const selectedTrackValue = selectElement.value;
      const tracks = videoElement.audioTracks;
      let trackChanged = false;
      for (let i = 0; i < tracks.length; i++) {
           const track = tracks[i];
           const isSelectedTrack = (track.id && track.id === selectedTrackValue) || String(i) === selectedTrackValue;
           if (track.enabled !== isSelectedTrack) {
                try {
                    track.enabled = isSelectedTrack;
                    if (isSelectedTrack) console.log("Enabled audio track:", track.label || track.id || i);
                    trackChanged = true;
                }
                catch (e) { console.error("Error changing audio track state for track:", track.id || i, e); }
           }
      }
      if (!trackChanged) console.warn("Selected audio track already active or no change applied.");
  }


// --- External Player / Copy Functionality ---
function openWithIntent(url) {
    if (!url) return;
    const mime = getMimeTypeFromUrl(url);
    const videoTitleEncoded = encodeURIComponent(videoTitle?.innerText || document.title || 'Video');
    const genericIntentUri = `intent:${url}#Intent;type=${mime};action=android.intent.action.VIEW;S.title=${videoTitleEncoded};end`;
    console.log("Attempting generic VIEW intent:", genericIntentUri);
    window.location.href = genericIntentUri;
}

function copyVLCLink(buttonElement, url) {
    if (!url) return;
    const currentActionRow = buttonElement.closest('.action-row');
    const feedbackSpan = currentActionRow?.querySelector('.copy-feedback');

    if (navigator.clipboard && navigator.clipboard.writeText && window.isSecureContext) {
        navigator.clipboard.writeText(url).then(() => {
            if (feedbackSpan) showCopyFeedback(feedbackSpan);
        }).catch(err => {
            console.error("Async clipboard write failed:", err);
            alert("Could not copy URL automatically. Please copy manually.");
            highlightVlcText();
        });
    } else {
        console.warn("Using fallback clipboard method.");
        fallbackCopyTextToClipboard(url, feedbackSpan);
    }
}

function fallbackCopyTextToClipboard(text, feedbackSpan) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.position = "fixed"; textArea.style.top = "-9999px"; textArea.style.left = "-9999px";
    textArea.style.opacity = "0";
    textArea.setAttribute("readonly", "");
    document.body.appendChild(textArea);
    let successful = false;
    try {
        textArea.select();
        textArea.setSelectionRange(0, textArea.value.length);
        successful = document.execCommand('copy');
        if (successful && feedbackSpan) showCopyFeedback(feedbackSpan);
        else if (!successful) throw new Error('execCommand returned false');
    } catch (err) {
        console.error('Fallback copy failed:', err);
        alert("Automatic copy failed. Please select and copy the URL manually.");
        highlightVlcText();
    } finally {
        document.body.removeChild(textArea);
    }
}

function showCopyFeedback(spanElement) {
    if (!spanElement) return;
    clearTimeout(copyTimeout);
    spanElement.classList.add('show');
    copyTimeout = setTimeout(() => {
        spanElement.classList.remove('show');
    }, 2000);
}

function highlightVlcText() {
     if (vlcText && vlcBox?.style.display === 'block') {
         try {
             const range = document.createRange(); range.selectNodeContents(vlcText);
             const selection = window.getSelection();
             if (selection) {
                 selection.removeAllRanges(); selection.addRange(range);
             }
         } catch (selectErr) {
             console.warn("Could not highlight VLC text:", selectErr);
         }
     }
}


// --- State Persistence ---
function saveStateToLocalStorage() {
    try {
        const stateToSave = {
            searchTerm: currentState.searchTerm,
            qualityFilter: currentState.qualityFilter,
            sortColumn: currentState.sortColumn,
            sortDirection: currentState.sortDirection,
            currentPage: currentState.currentPage
        };
        localStorage.setItem(config.LOCAL_STORAGE_KEY, JSON.stringify(stateToSave));
    }
    catch (e) { console.error("Failed to save state to localStorage:", e); }
}

function loadStateFromLocalStorage() {
    try {
        const savedState = localStorage.getItem(config.LOCAL_STORAGE_KEY);
        if (savedState) {
            const parsedState = JSON.parse(savedState);
            currentState.searchTerm = typeof parsedState.searchTerm === 'string' ? parsedState.searchTerm : '';
            currentState.qualityFilter = typeof parsedState.qualityFilter === 'string' ? parsedState.qualityFilter : '';
            currentState.sortColumn = typeof parsedState.sortColumn === 'string' ? parsedState.sortColumn : 'lastUpdated';
            currentState.sortDirection = (typeof parsedState.sortDirection === 'string' && ['asc', 'desc'].includes(parsedState.sortDirection)) ? parsedState.sortDirection : 'desc';
            currentState.currentPage = (typeof parsedState.currentPage === 'number' && parsedState.currentPage > 0) ? Math.floor(parsedState.currentPage) : 1;

            if(searchInput) searchInput.value = currentState.searchTerm;
        }
    } catch (e) {
        console.error("Failed to load state from localStorage:", e);
        localStorage.removeItem(config.LOCAL_STORAGE_KEY);
    }
}

// --- Initial Data Loading and Setup ---
async function loadInitialData() {
    const loadingHTML = '<tr><td colspan="6" class="status-message">Loading... <div class="spinner" style="margin: 10px auto;"></div></td></tr>';
    if(updatesTableBody) updatesTableBody.innerHTML = loadingHTML;
    if(movieTableBody) movieTableBody.innerHTML = loadingHTML;
    if(paginationControlsContainer) paginationControlsContainer.style.display = 'none';

    uniqueQualities.clear();
    loadStateFromLocalStorage();

    try {
        // Check if the URL is still the default placeholder
        if (!config.GSheetWebAppURL || config.GSheetWebAppURL.includes("macros/library/d/")) {
            throw new Error("Google Sheet Web App URL is missing or incorrect. Please paste your deployed script URL into the 'config' object in the JavaScript code.");
        }

        console.log("Fetching data from:", config.GSheetWebAppURL);
        const response = await fetch(config.GSheetWebAppURL);
        console.log("Fetch response status:", response.status);

        if (!response.ok) {
             let errorText = `Network error: ${response.statusText || `HTTP status ${response.status}`}`;
             try {
                const errorData = await response.json(); // Try to get error message from backend JSON response
                if(errorData?.error) errorText = `API Error: ${errorData.error}`;
             } catch(e) { /* Ignore if response body isn't JSON */ }
             throw new Error(errorText);
        }

        const result = await response.json();

        if (result.error) throw new Error(`API Error: ${result.error}`); // Check for errors returned within the JSON data
        if (!Array.isArray(result.data)) throw new Error("Invalid data format received from API (expected 'data' array).");

        allMovieData = result.data
                        .filter(movie => movie && (movie.id || movie.filename || movie.url)) // Basic validation
                        .map(preprocessMovieData); // Process each valid item

        console.log(`Successfully processed ${allMovieData.length} movie items.`);

        populateQualityFilter(); // Populate dropdown based on processed data

        // Restore selected quality filter if it exists
        if(qualityFilterSelect && uniqueQualities.has(currentState.qualityFilter)) {
             qualityFilterSelect.value = currentState.qualityFilter;
        } else {
             currentState.qualityFilter = '';
             if (qualityFilterSelect) qualityFilterSelect.value = '';
        }

        applyUserActions(); // Apply initial filters/sort and render

    } catch (error) {
        console.error('FATAL: Failed to load or process initial data:', error);
        displayLoadError(`Error loading movie data: ${error.message}. Please check the script URL, sheet configuration, and ensure the script is deployed correctly. Then refresh the page.`);
    }
}

/**
 * Populates the quality filter dropdown with unique qualities found in the data.
 */
function populateQualityFilter() {
    if (!qualityFilterSelect) return;
    const currentSelectedValue = currentState.qualityFilter;
    qualityFilterSelect.innerHTML = '<option value="">All Qualities</option>';

    const sortedQualities = [...uniqueQualities].sort((a, b) => {
        const resRegex = /^(4K|\d{3,4})P$/i;
        const sourceRegex = /^(WEBDL|WEBRip|BluRay|BDRip|BRRip|HDTV|HDRip|DVD|DVDScr|HDCAM|HC|TC|TS|CAM)$/i;
        const getScore = (q) => {
            q = String(q || '').toUpperCase();
            if (q === '4K' || q === '2160P') return 10;
            if (q === '1080P') return 9;
            if (q === '720P') return 8;
            if (q === '480P') return 7;
            if (sourceRegex.test(q)) return 6;
            if (['HDR', 'DOLBY VISION', 'DV', 'HEVC', 'X265'].includes(q)) return 5;
            return 0;
        };
        const scoreA = getScore(a);
        const scoreB = getScore(b);
        if (scoreA !== scoreB) return scoreB - scoreA;
        return String(a || '').localeCompare(String(b || ''), undefined, { sensitivity: 'base' });
    });

    sortedQualities.forEach(quality => {
        if (quality) {
            const option = document.createElement('option');
            option.value = quality; option.textContent = quality;
            qualityFilterSelect.appendChild(option);
        }
    });

    if (currentSelectedValue && sortedQualities.includes(currentSelectedValue)) {
         qualityFilterSelect.value = currentSelectedValue;
    }
    updateFilterIndicator();
}

/**
 * Displays a critical error message in the table bodies.
 */
function displayLoadError(message) {
    const errorMsgHTML = `<tr><td colspan="6" class="error-message">${sanitize(message)}</td></tr>`;
    if (updatesTableBody) updatesTableBody.innerHTML = errorMsgHTML;
    if (movieTableBody) movieTableBody.innerHTML = errorMsgHTML;
    if (paginationControlsContainer) paginationControlsContainer.style.display = 'none';
    if (updatesSection) updatesSection.style.display = 'block';
}

/**
 * Called when search criteria changes.
 */
function triggerSearch() {
    if (!searchInput) return;
    const newSearchTerm = searchInput.value;
    if (newSearchTerm !== currentState.searchTerm) {
        currentState.searchTerm = newSearchTerm;
        currentState.currentPage = 1;
        closePlayerIfNeeded();
        applyUserActions();
    }
}

// --- Keyboard Shortcuts for Player ---
function handlePlayerKeyboardShortcuts(event) {
    if (!videoContainer || videoContainer.style.display !== 'flex' || !videoElement) {
        return;
    }
    const targetTagName = event.target.tagName.toLowerCase();
    if (targetTagName === 'input' || targetTagName === 'select' || targetTagName === 'textarea') {
        return;
    }

    const key = event.key;
    let prevented = false;
    switch (key) {
        case ' ': case 'k': togglePlayPause(); prevented = true; break;
        case 'ArrowLeft': seekVideo(-10); prevented = true; break;
        case 'ArrowRight': seekVideo(10); prevented = true; break;
        case 'ArrowUp': setVolume(Math.min(videoElement.volume + 0.05, 1)); prevented = true; break;
        case 'ArrowDown': setVolume(Math.max(videoElement.volume - 0.05, 0)); prevented = true; break;
        case 'm': toggleMute(); prevented = true; break;
        case 'f': toggleFullscreen(); prevented = true; break;
    }
    if (prevented) { event.preventDefault(); }
}


// --- Global Event Listeners Setup ---
document.addEventListener('DOMContentLoaded', () => {
    loadInitialData();

    // --- Search ---
    if (searchInput) {
        searchInput.addEventListener('input', () => {
            clearTimeout(searchDebounceTimeout);
            searchDebounceTimeout = setTimeout(triggerSearch, config.SEARCH_DEBOUNCE_DELAY);
        });
        searchInput.addEventListener('keydown', (event) => {
             if (event.key === 'Enter') {
                 event.preventDefault(); clearTimeout(searchDebounceTimeout); triggerSearch();
             }
         });
        searchInput.addEventListener('search', () => { // Handles 'x' clear button
            clearTimeout(searchDebounceTimeout);
            setTimeout(() => { if (searchInput.value === '') triggerSearch(); }, 0);
        });
    }

    // --- Filter ---
    if (qualityFilterSelect) {
        qualityFilterSelect.addEventListener('change', () => {
            currentState.qualityFilter = qualityFilterSelect.value;
            currentState.currentPage = 1;
            closePlayerIfNeeded();
            applyUserActions();
        });
    }

    // --- Sort ---
    if (movieTableHead) {
        movieTableHead.addEventListener('click', handleSort);
    }

    // --- Player Keyboard ---
    document.addEventListener('keydown', handlePlayerKeyboardShortcuts);

});

// ]]>
</script>

</body>
</html>
